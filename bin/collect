#!/usr/bin/env ruby

require 'tsm'
require 'awesome_print'
require 'logger'

LOOPS = 2
SLEEP = 10 
OUTDIR = "/tmp"

# Setup
log = Logger.new(STDOUT)
srv = Tsm::Server.new

# Commands to run each time
cmds = [ 
  'select MACHINE_GUID from status',
  'q db',
  'q log f=d',
  'q vol f=d',
  'q pro',
  'q sess f=d',
  'q mount f=d',
  'q act',
  'q drive f=d',
  'q path f=d',
  'q node f=d'
]

1.upto(LOOPS) do |i|

  log.info "Start loop #{i}/#{LOOPS}."
  cmds.each do |c| 
    log.info "Get command: #{c}"
    srv.exec(c)
  end

  outfile = [ OUTDIR, "/TSMDATA-", Time.now.to_i ].join
  log.info "Output to file: #{outfile}"
  srv.save(outfile)

  log.info "Finished loop #{i}/#{LOOPS}."

  unless i == LOOPS
    log.info "Sleeping for #{SLEEP}"
    sleep SLEEP
  end

end

log.info "Finished, closing connection."
srv.close
